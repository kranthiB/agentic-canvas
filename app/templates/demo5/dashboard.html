{% extends "base.html" %}

{% block title %}Engineer's Copilot - TotalEnergies{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/demo5-common.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-robot"></i> Engineer's Copilot
                </h2>
                <p class="mb-0 small opacity-75">AI Research Assistant for TCAP Mumbai Lubricant Development</p>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <div class="language-toggle">
                    <button onclick="setLanguage('english')" id="btnEnglish" class="active">
                        <i class="bi bi-globe"></i> English
                    </button>
                    <button onclick="setLanguage('hindi')" id="btnHindi">
                        <i class="bi bi-translate"></i> हिंदी
                    </button>
                </div>
                <a href="{{ url_for('demo5_simulation.event_flow_dashboard') }}" class="btn btn-light btn-sm">
                    <i class="bi bi-diagram-3"></i> Event Flow
                </a>
            </div>
        </div>
    </div>

    <!-- Metrics Row -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #667eea;">
                <h4 class="mb-1">{{ stats.active_products if stats.active_products else 20 }}</h4>
                <small class="text-muted">Active Products</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #f5576c;">
                <h4 class="mb-1">
                    {% set trials = stats.formulation_trials %}
                    {{ (trials.in_progress + trials.testing) if trials else 8 }}
                </h4>
                <small class="text-muted">Ongoing Trials</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #4facfe;">
                <h4 class="mb-1">{{ stats.queries_today if stats.queries_today else 0 }}</h4>
                <small class="text-muted">Queries Today</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #43e97b;">
                <h4 class="mb-1">6/6</h4>
                <small class="text-muted">Systems Connected</small>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-container">
        <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots-fill"></i> Ask me anything about formulations, testing, regulations, or supply chain
                </h5>
                <button class="clear-chat" onclick="clearChat()">
                    <i class="bi bi-arrow-counterclockwise"></i> Clear Chat
                </button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <i class="bi bi-chat-square-text"></i>
                <h5>How can I help you today?</h5>
                <p>Ask me about formulations, test protocols, regulations, or supply chain</p>
                
                <div class="suggestions">
                    <div class="suggestion-chip" onclick="askQuestion('What\\'s the recommended viscosity index improver dosage for Quartz 9000 5W-30?')">
                        <i class="bi bi-flask"></i>
                        VI Improver Dosage
                    </div>
                    <div class="suggestion-chip" onclick="askQuestion('Which suppliers can deliver Group III base oil to Mumbai within 2 weeks?')">
                        <i class="bi bi-truck"></i>
                        Supplier Availability
                    </div>
                    <div class="suggestion-chip" onclick="askQuestion('Can we reduce ZDDP to meet BS VI compliance?')">
                        <i class="bi bi-shield-check"></i>
                        BS VI Compliance
                    </div>
                    <div class="suggestion-chip" onclick="askQuestion('What are the test requirements for automotive LPG?')">
                        <i class="bi bi-clipboard-check"></i>
                        LPG Testing
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Type your question here..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="btn-send" id="btnSend" onclick="sendMessage()">
                    <span class="spinner"></span>
                    <span class="send-icon">
                        <i class="bi bi-send-fill"></i> Send
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentLanguage = localStorage.getItem('language') || 'english';
let messageCount = 0;
let isProcessing = false;

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    document.getElementById('btnEnglish').classList.toggle('active', lang === 'english');
    document.getElementById('btnHindi').classList.toggle('active', lang === 'hindi');
}

// Set initial language
setLanguage(currentLanguage);

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey && !isProcessing) {
        event.preventDefault();
        sendMessage();
    }
}

function askQuestion(question) {
    if (isProcessing) return;
    document.getElementById('chatInput').value = question;
    sendMessage();
}

function clearChat() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
        <div class="empty-state" id="emptyState">
            <i class="bi bi-chat-square-text"></i>
            <h5>How can I help you today?</h5>
            <p>Ask me about formulations, test protocols, regulations, or supply chain</p>
            
            <div class="suggestions">
                <div class="suggestion-chip" onclick="askQuestion('What\\'s the recommended viscosity index improver dosage for Quartz 9000 5W-30?')">
                    <i class="bi bi-flask"></i>
                    VI Improver Dosage
                </div>
                <div class="suggestion-chip" onclick="askQuestion('Which suppliers can deliver Group III base oil to Mumbai within 2 weeks?')">
                    <i class="bi bi-truck"></i>
                    Supplier Availability
                </div>
                <div class="suggestion-chip" onclick="askQuestion('Can we reduce ZDDP to meet BS VI compliance?')">
                    <i class="bi bi-shield-check"></i>
                    BS VI Compliance
                </div>
                <div class="suggestion-chip" onclick="askQuestion('What are the test requirements for automotive LPG?')">
                    <i class="bi bi-clipboard-check"></i>
                    LPG Testing
                </div>
            </div>
        </div>
    `;
    messageCount = 0;
}

async function sendMessage() {
    if (isProcessing) return;
    
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    isProcessing = true;
    
    // Hide empty state
    const emptyState = document.getElementById('emptyState');
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    // Clear input
    input.value = '';
    
    // Disable controls
    const btnSend = document.getElementById('btnSend');
    btnSend.disabled = true;
    btnSend.classList.add('loading');
    input.disabled = true;
    
    // Add user message
    await addMessage('user', message);
    await sleep(300);
    
    // Add typing indicator with processing status
    addTypingIndicator();
    
    // Simulate processing steps
    const steps = [
        'Analyzing your question...',
        'Routing to appropriate agents...',
        'Searching knowledge base...',
        'Querying enterprise systems...',
        'Generating response...'
    ];
    
    for (let i = 0; i < steps.length; i++) {
        updateProcessingStatus(steps[i]);
        await sleep(600); // Delay between steps
    }
    
    // Determine scenario based on keywords
    const scenarioId = detectScenario(message);
    
    // Send to API
    try {
        const response = await fetch('/demo5/api/query/process', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                query: message,
                scenario_id: scenarioId,
                language: currentLanguage
            })
        });
        
        const data = await response.json();
        
        // Extra delay for realism
        await sleep(800);
        
        // Remove typing indicator
        removeTypingIndicator();
        
        if (data.success) {
            // Add assistant response
            await addMessage('assistant', data.response, {
                agents: data.agents,
                sources: data.sources,
                processingTime: data.processing_time_ms
            });
        } else {
            await addMessage('assistant', `Error: ${data.error}`, { isError: true });
        }
    } catch (err) {
        removeTypingIndicator();
        await addMessage('assistant', `Error: ${err.message}`, { isError: true });
    } finally {
        // Re-enable controls
        btnSend.disabled = false;
        btnSend.classList.remove('loading');
        input.disabled = false;
        input.focus();
        isProcessing = false;
    }
}

function detectScenario(message) {
    const msg = message.toLowerCase();
    
    // Only match very specific scenario patterns to avoid interfering with query handlers
    // Let query handlers handle the specific questions first
    if (msg.includes('simulate') && msg.includes('contamination') && msg.includes('lpg')) {
        return 'scenario4';
    } else if (msg.includes('simulate') && msg.includes('bs vi') && msg.includes('emission')) {
        return 'scenario3';
    } else if (msg.includes('simulate') && msg.includes('supplier') && msg.includes('500 mt')) {
        return 'scenario2';
    } else if (msg.includes('simulate') && msg.includes('vi improver') && msg.includes('dosage optimization')) {
        return 'scenario1';
    }
    
    // Return null for all other queries to let query handlers process them
    return null;
}

async function addMessage(role, content, metadata = {}) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.style.opacity = '0';
    
    const avatarIcon = role === 'user' ? 'person-fill' : 'robot';
    
    let metaHtml = '';
    if (metadata.agents && metadata.agents.length > 0) {
        metaHtml += `<div class="message-meta">`;
        metaHtml += `<span><i class="bi bi-cpu"></i> ${metadata.agents.join(', ')}</span>`;
        
        if (metadata.sources && metadata.sources.length > 0) {
            metadata.sources.forEach(s => {
                metaHtml += `<span class="source-badge"><i class="bi bi-database"></i> ${s.type}</span>`;
            });
        }
        
        if (metadata.processingTime) {
            metaHtml += `<span><i class="bi bi-clock"></i> ${metadata.processingTime}ms</span>`;
        }
        
        metaHtml += `</div>`;
    }
    
    const contentClass = metadata.isError ? 'text-danger' : '';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-${avatarIcon}"></i>
        </div>
        <div class="message-content ${contentClass}">
            ${formatMessage(content)}
            ${metaHtml}
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    
    // Animate in
    await sleep(50);
    messageDiv.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
    messageDiv.style.opacity = '1';
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    messageCount++;
}

function formatMessage(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>')
        .replace(/✓/g, '<i class="bi bi-check-circle-fill text-success"></i>')
        .replace(/✗/g, '<i class="bi bi-x-circle-fill text-danger"></i>')
        .replace(/⭐/g, '<i class="bi bi-star-fill text-warning"></i>');
}

function addTypingIndicator() {
    const messagesContainer = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message assistant';
    typingDiv.id = 'typingIndicator';
    
    typingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-robot"></i>
        </div>
        <div class="message-content">
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <div class="processing-status" id="processingStatus"></div>
        </div>
    `;
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function updateProcessingStatus(status) {
    const statusEl = document.getElementById('processingStatus');
    if (statusEl) {
        statusEl.textContent = status;
    }
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Focus input on load
window.addEventListener('load', () => {
    document.getElementById('chatInput').focus();
});
</script>
{% endblock %}
