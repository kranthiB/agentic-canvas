{% extends "base.html" %}

{% block title %}Network Map - Mobility Maestro{% endblock %}

{% block extra_css %}
<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<!-- Custom Map CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/demo4-map.css') }}">
{% endblock %}

{% block content %}
<div class="map-container">
    <!-- Header - Demo5 Style -->
    <div class="map-header">
        <div class="header-left">
            <h2 class="map-title">
                <i class="fas fa-map-marked-alt"></i>
                EV Charging Network Map
            </h2>
            <p class="map-subtitle">Interactive visualization of charging stations across India</p>
        </div>
        <div class="header-right">
            <a href="{{ url_for('demo4_scenario.event_flow_page') }}" class="btn btn-primary">
                <i class="fas fa-project-diagram"></i> Event Flow
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="map-content">
        <!-- Sidebar -->
        <div class="map-sidebar">
            <!-- Statistics Panel -->
            <div class="sidebar-panel">
                <h3 class="panel-title">
                    <i class="fas fa-chart-bar"></i>
                    Network Statistics
                </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Sites</div>
                        <div class="stat-value" id="totalSites">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Evaluated</div>
                        <div class="stat-value text-success" id="evaluatedSites">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">High Score</div>
                        <div class="stat-value text-warning" id="highScoreSites">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Cities</div>
                        <div class="stat-value text-info" id="citiesCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Filters Panel -->
            <div class="sidebar-panel">
                <h3 class="panel-title">
                    <i class="fas fa-filter"></i>
                    Filters
                </h3>
                
                <!-- City Tier Filter -->
                <div class="filter-group">
                    <label class="filter-label">City Tier</label>
                    <div class="btn-group-vertical w-100">
                        <button class="btn btn-filter active" data-filter="tier" data-value="all">
                            <i class="fas fa-globe"></i> All Tiers
                        </button>
                        <button class="btn btn-filter" data-filter="tier" data-value="tier_1">
                            <i class="fas fa-city"></i> Tier 1 (Metro)
                        </button>
                        <button class="btn btn-filter" data-filter="tier" data-value="tier_2">
                            <i class="fas fa-building"></i> Tier 2 (Major)
                        </button>
                        <button class="btn btn-filter" data-filter="tier" data-value="tier_3">
                            <i class="fas fa-home"></i> Tier 3 (Emerging)
                        </button>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                    <label class="filter-label">Site Status</label>
                    <div class="btn-group-vertical w-100">
                        <button class="btn btn-filter active" data-filter="status" data-value="all">
                            <i class="fas fa-list"></i> All Status
                        </button>
                        <button class="btn btn-filter" data-filter="status" data-value="evaluated">
                            <i class="fas fa-check-circle"></i> Evaluated
                        </button>
                        <button class="btn btn-filter" data-filter="status" data-value="candidate">
                            <i class="fas fa-hourglass-half"></i> Candidate
                        </button>
                        <button class="btn btn-filter" data-filter="status" data-value="selected">
                            <i class="fas fa-star"></i> Selected
                        </button>
                    </div>
                </div>

                <!-- Score Range Filter -->
                <div class="filter-group">
                    <label class="filter-label">
                        Score Range: <span id="scoreRangeValue">0-100</span>
                    </label>
                    <input type="range" class="form-range" id="scoreRange" min="0" max="100" value="0">
                </div>
            </div>

            <!-- Layers Panel -->
            <div class="sidebar-panel">
                <h3 class="panel-title">
                    <i class="fas fa-layers"></i>
                    Map Layers
                </h3>
                
                <div class="layer-toggle">
                    <label class="layer-label">
                        <input type="checkbox" id="layerSites" checked>
                        <i class="fas fa-charging-station"></i>
                        Charging Stations
                    </label>
                </div>
                
                <div class="layer-toggle">
                    <label class="layer-label">
                        <input type="checkbox" id="layerClusters" checked>
                        <i class="fas fa-object-group"></i>
                        Cluster Markers
                    </label>
                </div>
                
                <div class="layer-toggle">
                    <label class="layer-label">
                        <input type="checkbox" id="layerHeatmap">
                        <i class="fas fa-fire"></i>
                        Traffic Heatmap
                    </label>
                </div>
                
                <div class="layer-toggle">
                    <label class="layer-label">
                        <input type="checkbox" id="layerCityLabels" checked>
                        <i class="fas fa-tags"></i>
                        City Labels
                    </label>
                </div>
            </div>

            <!-- Scenario Panel -->
            <div class="sidebar-panel">
                <h3 class="panel-title">
                    <i class="fas fa-play-circle"></i>
                    Quick Scenarios
                </h3>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-scenario btn-success" id="scenarioExpansion">
                        <i class="fas fa-expand-arrows-alt"></i>
                        Mumbai Expansion
                    </button>
                    <button class="btn btn-scenario btn-info" id="scenarioOptimization">
                        <i class="fas fa-chart-line"></i>
                        Network Optimization
                    </button>
                    <button class="btn btn-scenario btn-warning" id="scenarioCrisis">
                        <i class="fas fa-exclamation-triangle"></i>
                        Crisis Response
                    </button>
                </div>
            </div>

            <!-- Legend -->
            <div class="sidebar-panel">
                <h3 class="panel-title">
                    <i class="fas fa-info-circle"></i>
                    Legend
                </h3>
                
                <div class="legend-item">
                    <div class="legend-marker marker-excellent"></div>
                    <div class="legend-text">Excellent (80-100)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-good"></div>
                    <div class="legend-text">Good (65-79)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-fair"></div>
                    <div class="legend-text">Fair (50-64)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-poor"></div>
                    <div class="legend-text">Poor (&lt;50)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-unevaluated"></div>
                    <div class="legend-text">Not Evaluated</div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-wrapper">
            <div id="networkMap"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-control-btn" id="btnZoomIn" title="Zoom In" aria-label="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="map-control-btn" id="btnZoomOut" title="Zoom Out" aria-label="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="map-control-btn" id="btnResetView" title="Reset View" aria-label="Reset View">
                    <i class="fas fa-undo-alt"></i>
                </button>
                <button class="map-control-btn" id="btnLocateMe" title="My Location" aria-label="My Location">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="map-control-btn" id="btnFullscreen" title="Fullscreen" aria-label="Toggle Fullscreen">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
            </div>

            <!-- Search Box -->
            <div class="map-search">
                <div class="search-input-group">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search by city, state, or site ID...">
                    <button id="btnClearSearch" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>

            <!-- Active Scenario Overlay -->
            <div id="scenarioOverlay" class="scenario-overlay" style="display: none;">
                <div class="scenario-overlay-content">
                    <div class="scenario-overlay-header">
                        <h4 id="scenarioOverlayTitle"></h4>
                        <button id="btnCloseScenario" class="btn-close-scenario">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="scenario-overlay-body">
                        <div class="scenario-progress">
                            <div class="progress-bar" id="scenarioProgress"></div>
                        </div>
                        <div id="scenarioStatus" class="scenario-status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Detail Modal -->
    <div id="siteDetailModal" class="site-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalSiteTitle"></h3>
                <button class="btn-close" id="btnCloseModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="mapLoadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading map data...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="{{ url_for('static', filename='js/demo4/map-controller.js') }}"></script>
<script src="{{ url_for('static', filename='js/demo4/map-scenarios.js') }}"></script>
{% endblock %}
